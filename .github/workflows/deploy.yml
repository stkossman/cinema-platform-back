name: Deploy to MonsterASP via Web Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore ./Cinema.Api/Cinema.Api.csproj
    
    - name: Apply Production Settings
      uses: microsoft/variable-substitution@v1
      with:
        files: './Cinema.Api/appsettings.json'
      env:
        ConnectionStrings.DefaultConnection: ${{ secrets.CONNECTION_STRING }}
        ConnectionStrings.RedisConnection: ${{ secrets.REDIS_CONN }}
        JwtSettings.Secret: ${{ secrets.JWT_SECRET }}
        Tmdb.ApiKey: ${{ secrets.TMDB_API_KEY }}
    
    - name: Build and Publish
      run: dotnet publish ./Cinema.Api/Cinema.Api.csproj -c Release -o ./publish
    
    - name: Install Web Deploy
      shell: pwsh
      run: |
        Write-Host "Downloading Web Deploy..."
        $url = "https://download.microsoft.com/download/0/1/D/01DC28EA-638C-4A22-A57B-4CEF97755C6C/WebDeploy_amd64_en-US.msi"
        $output = "$env:TEMP\WebDeploy.msi"
        
        try {
            Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
            Write-Host "Installing Web Deploy..."
            Start-Process msiexec.exe -ArgumentList "/i `"$output`" /quiet /norestart" -Wait -NoNewWindow
            Write-Host "Web Deploy installed successfully"
        }
        catch {
            Write-Error "Failed to install Web Deploy: $_"
            exit 1
        }
    
    - name: Deploy to MonsterASP
      shell: pwsh
      env:
        WEBDEPLOY_URL: ${{ secrets.WEBDEPLOY_URL }}
        WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
        WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        WEBDEPLOY_SITE: ${{ secrets.WEBDEPLOY_SITE }}
      run: |
        $publishUrl = $env:WEBDEPLOY_URL
        $userName = $env:WEBDEPLOY_USERNAME
        $password = $env:WEBDEPLOY_PASSWORD
        $siteName = $env:WEBDEPLOY_SITE
        $sourcePath = "${{ github.workspace }}\publish"
        
        Write-Host "========================================="
        Write-Host "Starting Web Deploy..."
        Write-Host "Source: $sourcePath"
        Write-Host "Destination Site: $siteName"
        Write-Host "Server: $publishUrl"
        Write-Host "========================================="
        
        $msdeployPath = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
        
        if (-Not (Test-Path $msdeployPath)) {
            Write-Error "MSDeploy not found at $msdeployPath"
            exit 1
        }

        $arguments = @(
            "-verb:sync",
            "-source:contentPath=$sourcePath",
            "-dest:contentPath=$siteName,ComputerName=$publishUrl,UserName=$userName,Password=$password,AuthType=Basic",
            "-enableRule:AppOffline",
            "-allowUntrusted",
            "-verbose",
            "-retryAttempts:3",
            "-retryInterval:5000"
        )
        
        Write-Host "Executing msdeploy with arguments:"
        $arguments | ForEach-Object { 
            if ($_ -notmatch "Password") { 
                Write-Host "  $_" 
            } else {
                Write-Host "  [argument with password - hidden]"
            }
        }
        
        try {
            & $msdeployPath @arguments
            
            if ($LASTEXITCODE -ne 0) {
                Write-Error "Deployment failed with exit code $LASTEXITCODE"
                exit $LASTEXITCODE
            }
            
            Write-Host "========================================="
            Write-Host "Deployment completed successfully!"
            Write-Host "========================================="
        }
        catch {
            Write-Error "Deployment failed: $_"
            Write-Error $_.Exception.Message
            Write-Error $_.ScriptStackTrace
            exit 1
        }
